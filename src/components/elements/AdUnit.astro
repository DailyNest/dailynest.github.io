---
import { GOOGLE_CONFIG } from "@/utils/google-config";

interface Props {
  adSlot: string;
  adType?: "in-article" | "display" | "fluid-layout" | "autorelaxed";
  adFormat?: string;
  adLayout?: string;
  adLayoutKey?: string;
  className?: string;
  refreshInterval?: number; // in seconds, default 5
}

const {
  adSlot,
  adType = "in-article",
  adFormat,
  adLayout,
  adLayoutKey,
  className = "",
  refreshInterval = 5,
} = Astro.props;

// Generate unique ID for this ad instance
const adId = `ad-${adType}-${adSlot}-${Math.random().toString(36).substr(2, 9)}`;
---

{
  GOOGLE_CONFIG.ADSENSE_CLIENT_ID && (
    <div id={adId} class={`ad-container ${className}`} style="min-height: 0;">
      <script
        is:inline
        async
        src={`https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=${GOOGLE_CONFIG.ADSENSE_CLIENT_ID}`}
        crossorigin="anonymous"
      />

      {adType === "display" && (
        <ins
          class="adsbygoogle"
          style="display:block; min-height: 0;"
          data-ad-client={GOOGLE_CONFIG.ADSENSE_CLIENT_ID}
          data-ad-slot={adSlot}
          data-ad-format={adFormat || "auto"}
          data-full-width-responsive="true"
        />
      )}

      {adType === "fluid-layout" && (
        <ins
          class="adsbygoogle"
          style="display:block"
          data-ad-format="fluid"
          data-ad-layout-key={adLayoutKey}
          data-ad-client={GOOGLE_CONFIG.ADSENSE_CLIENT_ID}
          data-ad-slot={adSlot}
        />
      )}

      {adType === "autorelaxed" && (
        <ins
          class="adsbygoogle"
          style="display:block"
          data-ad-format="autorelaxed"
          data-ad-client={GOOGLE_CONFIG.ADSENSE_CLIENT_ID}
          data-ad-slot={adSlot}
        />
      )}

      {adType === "in-article" && (
        <ins
          class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout={adLayout || "in-article"}
          data-ad-format={adFormat || "fluid"}
          data-ad-client={GOOGLE_CONFIG.ADSENSE_CLIENT_ID}
          data-ad-slot={adSlot}
        />
      )}

      <script is:inline>
        (adsbygoogle = window.adsbygoogle || []).push({});
      </script>

      <script is:inline define:vars={{ adId, refreshInterval }}>
        // Ad refresh functionality
        (function() {
          const adContainer = document.getElementById(adId);
          if (!adContainer) return;

          let refreshTimer;
          let refreshCount = 0;
          const maxRefreshes = 20; // Limit refreshes to prevent abuse

          function refreshAd() {
            const adElement = adContainer.querySelector('.adsbygoogle');
            if (!adElement) return;

            // Check if ad is loaded and visible
            const adStatus = adElement.getAttribute('data-ad-status');
            const isVisible = adContainer.offsetWidth > 0 && adContainer.offsetHeight > 0;

            if (adStatus === 'filled' && isVisible && refreshCount < maxRefreshes) {
              try {
                // Clear existing ad
                adElement.innerHTML = '';

                // Re-push the ad
                (adsbygoogle = window.adsbygoogle || []).push({});

                refreshCount++;
                console.log(`Ad refreshed (${refreshCount}/${maxRefreshes}): ${adId}`);
              } catch (error) {
                console.warn('Ad refresh failed:', error);
              }
            }
          }

          // Start refreshing after initial load
          function startRefreshing() {
            if (refreshTimer) clearInterval(refreshTimer);

            refreshTimer = setInterval(refreshAd, refreshInterval * 1000);

            // Also refresh on visibility change (tab focus, etc.)
            document.addEventListener('visibilitychange', function() {
              if (!document.hidden) {
                setTimeout(refreshAd, 1000); // Small delay after tab becomes visible
              }
            });
          }

          // Wait for ad to load before starting refresh cycle
          const checkAdLoaded = setInterval(function() {
            const adElement = adContainer.querySelector('.adsbygoogle');
            if (adElement && adElement.getAttribute('data-ad-status') === 'filled') {
              clearInterval(checkAdLoaded);
              setTimeout(startRefreshing, 2000); // Start refreshing 2 seconds after initial load
            }
          }, 500);

          // Cleanup on page unload
          window.addEventListener('beforeunload', function() {
            if (refreshTimer) {
              clearInterval(refreshTimer);
            }
          });
        })();
      </script>

      <style>
        .ad-container {
          min-height: 0 !important;
        }
        .adsbygoogle {
          min-height: 0 !important;
        }
      </style>
    </div>
  )
}
