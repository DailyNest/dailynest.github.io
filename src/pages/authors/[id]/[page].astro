---
import type { GetStaticPaths } from "astro";
import { SITE } from "@/lib/config";
import { articlesHandler } from "@/lib/handlers/articles";
import { authorsHandler } from "@/lib/handlers/authors";
import ListLayout from "@/layouts/list.astro";
import WideCard from "@/components/cards/wideCard.astro";
import AdUnit from "@/components/elements/AdUnit.astro";
import Pagination from "@/components/shared/pagination.astro";
import { getEntry } from "astro:content";

export const getStaticPaths = (({ paginate }) => {
  const allAuthors = authorsHandler.allAuthors();
  const allArticles = articlesHandler.allArticles();

  return allAuthors.flatMap((author) => {
    const filteredArticles = allArticles.filter((article) =>
      article.data.authors.map((a) => a.id).includes(author.id),
    );
    return paginate(filteredArticles, {
      params: { id: author.id },
      pageSize: SITE.postsPerPage,
    });
  });
}) satisfies GetStaticPaths;

const { page } = Astro.props;
const params = Astro.params;
const articles = page.data;
const pathname = new URL(Astro.request.url).pathname.split("/");
const basePath = `${pathname[1]}/${pathname[2]}`;

const entry = await getEntry("views", "author");
const author = authorsHandler.findAuthor(params.id);

if (!entry) {
  return Astro.redirect("/404");
}

const [HEADER] = entry.data.blocks;
---

<ListLayout
  header={`${author.data.name} â€” ${HEADER.title}`}
  entry={{
    ...entry,
    data: {
      ...entry.data,
      // For meta: use "{Author Name} | Site" via getMeta by setting the view title to the author name only
      title: `${author.data.name}`,
      description: entry.data.description,
      keywords: entry.data.keywords || [],
    },
  }}
>
  <!-- Enhanced Person structured data for author page -->
  <script is:inline type="application/ld+json">
    {JSON.stringify({
      '@context': 'https://schema.org',
      '@type': 'Person',
      name: author.data.name,
      description: author.data.bio,
      jobTitle: author.data.job,
      url: `${SITE.url}/authors/${author.id}`,
      image: author.data.avatar?.src
        ? new URL(author.data.avatar.src, SITE.url).href
        : author.data.avatarUrl || undefined,
      sameAs: Array.isArray(author.data.social) && author.data.social.length > 0
        ? author.data.social.map((social) => social.url)
        : [],
      knowsAbout: [
        'Technology',
        'Web Development',
        'Open Source',
        'Programming',
        'Content Writing'
      ],
      hasOccupation: {
        '@type': 'Occupation',
        name: author.data.job,
        occupationLocation: {
          '@type': 'Country',
          name: 'Global'
        }
      },
      mainEntityOfPage: {
        '@type': 'WebPage',
        '@id': `${SITE.url}/authors/${author.id}`
      },
      potentialAction: {
        '@type': 'ViewAction',
        target: `${SITE.url}/authors/${author.id}`
      }
    })}
  </script>

  <!-- Organization schema for the blog/site -->
  <script is:inline type="application/ld+json">
    {JSON.stringify({
      '@context': 'https://schema.org',
      '@type': 'Organization',
      name: SITE.title,
      url: SITE.url,
      logo: `${SITE.url}/favicon.svg`,
      sameAs: [
        SITE.github
      ],
      founder: {
        '@type': 'Person',
        name: SITE.author
      },
      description: SITE.description,
      publishingPrinciples: `${SITE.url}/about`,
      ethicsPolicy: `${SITE.url}/privacy`,
      mission: 'Providing quality content on technology, programming, and personal development'
    })}
  </script>
  <section class="flex-1">
    <ul class="flex flex-col gap-4">
      {
        articles.map((article, index) => (
          <>
            <WideCard
              article={article}
              isLast={articles.lastIndexOf(article) === articles.length - 1}
            />
            {/* Insert ad after every 3rd item, but not after the last item */}
            {index > 0 && (index + 1) % 3 === 0 && index !== articles.length - 1 && (
              <li class="my-4">
                <AdUnit
                  adType="fluid-layout"
                  adSlot="5304666400"
                  adLayoutKey="-fb+5w+4e-db+86"
                  className="w-full"
                />
              </li>
            )}
          </>
        ))
      }
    </ul>
  </section>

  <Pagination
    length={page.lastPage}
    currentUrl={page.url.current}
    currentPage={page.currentPage}
    baseUrl={`/${basePath}`}
    prevUrl={page.url.prev}
    nextUrl={page.url.next}
    lastUrl={`/${basePath}/${page.lastPage}`}
  />
</ListLayout>
